import os
import hashlib
import csv
import requests
import subprocess
import Stage1.Log as Logger
import Stage1.GlobalVariables as Var


def mk_dir(directory):
    directory = directory.split('/')
    try:
        if os.name == 'nt':
            tmp = 'C:\\'
            for i in directory:
                tmp += i + "\\"
                try:
                    os.mkdir(tmp)
                except FileExistsError:
                    continue
            return tmp
        else:
            tmp = '/tmp/'
            for i in directory:
                tmp += i + "/"
                try:
                    os.mkdir(tmp)
                except FileExistsError:
                    continue
            return tmp
    except:
        return False


def download(url):
    try:
        new_folders = '/'.join(''.join(url.split('/master')[1:]).split('/')[1:-1])
        if mk_dir(Var.root_dir + new_folders):
            tmp = Var.root_dir + url.split("/master")[-1].split("/")[-1]
            with open(tmp, "wb") as f:
                f.write(requests.get(url).content)
                f.close()
            Logger.Log('a', 'b')
        return tmp

    except:
        return False


def check_integrity(filename, url):
    sha256sum_file = download(url)
    try:
        with open(sha256sum_file, 'r') as file:
            reader = csv.reader(file)
            sha256sum_dict = {rows[0]: rows[1] for rows in reader}
        os.remove(sha256sum_file)
        with open(filename, 'rb') as file:
            byte = file.read()
        sha256sum = hashlib.sha256(byte).hexdigest()
        if sha256sum_dict.get(filename) == sha256sum:
            return  True
        else:
            return False

    except:
        return False


exe = download("https://github.com/E1i0t/qwertyuiopasdfghjklzxcvbnm/raw/master/test.exe")
print(exe)
#subprocess.run([exe],shell=False)